import numpy as np
import pandas as pd
from pathlib import Path
from nilearn.masking import apply_mask
from nilearn.signal import clean
import logging

logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')

def load_and_clean_confounds(confound_file, selected_columns):
    confounds_df = pd.read_csv(confound_file, sep='\t')
    cols = [col for col in selected_columns if col in confounds_df.columns]
    confounds = confounds_df[cols].values
    logging.info(f"Loaded confounds with columns: {cols}")

    if np.isnan(confounds).any() or np.isinf(confounds).any():
        logging.warning("NaNs or infs detected in confounds; cleaning now...")
        confounds = np.nan_to_num(confounds, nan=0.0, posinf=0.0, neginf=0.0)

    return confounds

def extract_and_clean_timeseries(func_path, mask_path, confounds):
    ts = apply_mask(str(func_path), str(mask_path))
    logging.info(f"Extracted time series shape from {mask_path.name}: {ts.shape}")

    valid_voxels = np.all(np.isfinite(ts), axis=0)
    if not np.any(valid_voxels):
        raise ValueError(f"All voxels contain NaNs or infs in mask {mask_path.name}")

    ts_clean = ts[:, valid_voxels]
    ts_clean = clean(ts_clean, confounds=confounds, standardize="zscore_sample")

    if not np.all(np.isfinite(ts_clean)):
        raise ValueError(f"NaNs or infs detected after cleaning for mask {mask_path.name}")

    return ts_clean

def main():
    func_path = Path('/path/to/func.nii.gz')
    confound_file = func_path.parent / f"{func_path.stem}_desc-confounds_timeseries.tsv"
    output_dir = Path('/path/to/output')
    output_dir.mkdir(parents=True, exist_ok=True)

    selected_confounds = [
        'trans_x', 'trans_y', 'trans_z',
        'rot_x', 'rot_y', 'rot_z',
        'framewise_displacement',
        'a_comp_cor_00', 'a_comp_cor_01'
    ]

    confounds = load_and_clean_confounds(confound_file, selected_confounds)

    layers = {
        'Exteroception': Path('/home/stubanadean/ROIs_NII/Exteroception.nii.gz'),
        'Interoception': Path('/home/stubanadean/ROIs_NII/Interoception.nii.gz'),
        'Cognition': Path('/home/stubanadean/ROIs_NII/Cognition.nii.gz')
    }

    for layer_name, mask_path in layers.items():
        logging.info(f"Processing layer: {layer_name}")
        layer_output_dir = output_dir / layer_name
        layer_output_dir.mkdir(exist_ok=True)

        try:
            ts_clean = extract_and_clean_timeseries(func_path, mask_path, confounds)
            save_path = layer_output_dir / f"{func_path.stem}_{mask_path.stem}_voxelwise_timeseries.npy"
            np.save(save_path, ts_clean)
            logging.info(f"Saved cleaned timeseries to {save_path}")
        except Exception as e:
            logging.error(f"Failed processing {mask_path.name}: {e}")

if __name__ == '__main__':
    main()

